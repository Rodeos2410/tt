<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî Nexus Dark</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Fullscreen cart specific tweaks */
        body { align-items: stretch; }
        .full-cart {
            padding: 40px;
            display: flex;
            gap: 20px;
            max-width: none;
        }
        .cart-panel { width: 100%; border-radius: 8px; }
        .cart-items-list { max-height: 60vh; overflow: auto; }
    </style>
</head>
<body>
    <h1 class="rainbow-text-small">Nexus Dark</h1>
    <div class="top-right-controls">
        <a href="market.html" class="button" title="–ì–ª–∞–≤–Ω–∞—è"><span style="font-size:1.3em;">üè†</span></a>
        <a href="profile.html" class="button" title="–ü—Ä–æ—Ñ–∏–ª—å"><span style="font-size:1.3em;">üë§</span></a>
        <a href="users.html" class="button" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" id="adminNav" style="display:none;"><span style="font-size:1.3em;">üõ°Ô∏è</span></a>
        <a href="cart.html" class="button" title="–ö–æ—Ä–∑–∏–Ω–∞"><span style="font-size:1.3em;">üõí</span></a>
    </div>

    <main class="full-cart">
        <section style="flex:1">
            <div id="cartItemsFull" class="cart-items-list"></div>
        </section>
        <aside class="cart-panel">
            <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cartSummary"></div>
            <div class="cart-footer">
                <div class="cart-total">–ò—Ç–æ–≥–æ: <span id="cartTotalFull">0</span> ‚ÇΩ</div>
                <button id="checkoutBtnFull" class="button">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
            </div>
        </aside>
    </main>

    <script>
        function formatPrice(v) { return v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " "); }
        function renderFullCart() {
            const data = JSON.parse(localStorage.getItem('cart') || '[]');
            const itemsEl = document.getElementById('cartItemsFull');
            const sumEl = document.getElementById('cartTotalFull');
            const summaryEl = document.getElementById('cartSummary');
            itemsEl.innerHTML = '';
            let total = 0;
            if (data.length === 0) {
                // –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏—á–µ–≥–æ
                itemsEl.innerHTML = '';
            } else {
                        data.forEach((it, idx) => {
                            const card = document.createElement('div');
                            card.className = 'product-card';
                            card.style.display = 'flex';
                            card.style.gap = '12px';
                            card.style.alignItems = 'center';
                            card.innerHTML = `
                                <img src="${it.file_url || it.img || 'https://picsum.photos/seed/' + (it.id || idx) + '/200/140'}" alt="${it.title}" style="width:120px;height:80px;object-fit:cover;border-radius:6px;">
                                <div style="flex:1">
                                    <div style="font-weight:bold">${it.title}</div>
                                    <div style="color:#bbb;font-size:0.9rem">–¶–µ–Ω–∞: ${formatPrice(it.price)} ‚ÇΩ</div>
                                    <div style="margin-top:6px; display:flex; gap:8px; align-items:center">
                                        <button class="button" data-idx="${idx}" data-action="dec">-</button>
                                        <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <span id="qty-${idx}">${it.qty}</span></div>
                                        <button class="button" data-idx="${idx}" data-action="inc">+</button>
                                        <button class="button" data-idx="${idx}" data-action="remove" style="margin-left:12px">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div style="text-align:right">
                                    <div>–°—É–º–º–∞: <span id="sum-${idx}">${formatPrice(it.price * it.qty)}</span> ‚ÇΩ</div>
                                </div>
                            `;
                            itemsEl.appendChild(card);
                            total += it.price * it.qty;
                        });
            }
            const totalCount = data.reduce((s,i) => s + (i.qty||0), 0);
            summaryEl.innerHTML = data.length ? `<div>–ü–æ–∑–∏—Ü–∏–∏: ${data.length} (–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${totalCount})</div>` : '';
            sumEl.textContent = formatPrice(total);
        }
        function saveCart(data) { localStorage.setItem('cart', JSON.stringify(data)); }
        function updateQty(idx, delta) {
            const data = JSON.parse(localStorage.getItem('cart') || '[]');
            if (!data[idx]) return;
            data[idx].qty = Math.max(0, (data[idx].qty || 0) + delta);
            if (data[idx].qty === 0) data.splice(idx,1);
            saveCart(data);
            renderFullCart();
        }
        function removeItem(idx) { const data = JSON.parse(localStorage.getItem('cart') || '[]'); if (!data[idx]) return; data.splice(idx,1); saveCart(data); renderFullCart(); }
        document.addEventListener('DOMContentLoaded', () => {
            renderFullCart();
            document.getElementById('checkoutBtnFull').addEventListener('click', () => {
                if (!confirm('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
                const data = JSON.parse(localStorage.getItem('cart') || '[]');
                if (!data.length) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return; }
                const token = localStorage.getItem('authToken');
                if (token) {
                    const items = data.map(i => ({ product_id: i.id, qty: i.qty }));
                    fetch('http://localhost:8000/purchase/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(items) })
                        .then(r => { if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); return r.json(); })
                        .then(() => {
                            localStorage.removeItem('cart');
                            renderFullCart();
                            try { window.opener && window.opener.postMessage({ type: 'cartCleared' }, '*'); } catch(e){}
                            alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –°–ø–∞—Å–∏–±–æ!');
                        }).catch(() => {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                        });
                    return;
                }
                // guest fallback
                localStorage.removeItem('cart');
                renderFullCart();
                try { window.opener && window.opener.postMessage({ type: 'cartCleared' }, '*'); } catch(e){}
                alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω');
            });
            // delegate qty/change/remove buttons
            document.getElementById('cartItemsFull').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const idx = parseInt(btn.getAttribute('data-idx'), 10);
                const action = btn.getAttribute('data-action');
                if (isNaN(idx) || !action) return;
                if (action === 'inc') updateQty(idx, 1);
                if (action === 'dec') updateQty(idx, -1);
                if (action === 'remove') removeItem(idx);
            });
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.role === 'admin' || currentUser.email === 'admin@nexusdark.ru') {
                    const el = document.getElementById('adminNav'); if (el) el.style.display = '';
                }
        });
        window.addEventListener('storage', (e) => { if (e.key === 'cart') renderFullCart(); });
    </script>
</body>
</html>